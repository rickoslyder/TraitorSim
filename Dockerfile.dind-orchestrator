# Docker-in-Docker Orchestrator for TraitorSim
# This container runs the game engine and spawns agent containers internally
FROM docker:27-dind

# Install Python and dependencies
RUN apk add --no-cache \
    python3 \
    py3-pip \
    curl \
    bash \
    git

# Install Python packages (break-system-packages needed for Alpine)
RUN pip3 install --break-system-packages \
    anthropic>=0.40.0 \
    claude-agent-sdk>=0.1.0 \
    google-genai>=1.56.0 \
    numpy>=1.26.0 \
    python-dotenv>=1.0.0 \
    httpx>=0.27.0

# Create app directory
WORKDIR /app

# Copy entire project
COPY . /app/

# Create data directories
RUN mkdir -p /app/data/memories /app/data/games

# Copy entrypoint script
COPY orchestrator-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/orchestrator-entrypoint.sh

# Expose agent ports (for debugging/monitoring from host)
EXPOSE 18000-18009

# Set environment
ENV PYTHONUNBUFFERED=1
ENV DOCKER_HOST=unix:///var/run/docker.sock

# Use custom entrypoint
ENTRYPOINT ["/usr/local/bin/orchestrator-entrypoint.sh"]
