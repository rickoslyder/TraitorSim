version: '3.8'

services:
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.dind-orchestrator
    container_name: traitorsim-orchestrator
    privileged: true  # Required for Docker-in-Docker
    environment:
      # Pass API keys to orchestrator
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DOCKER_TLS_CERTDIR=/certs  # For DinD
    volumes:
      # Persist game data on host
      - ./data:/app/data
      # Docker certs for TLS
      - dind-certs:/certs
    # No ports needed - agents use internal Docker networking
    networks:
      - traitorsim-dind
    # Resource limits (adjust based on player count)
    mem_limit: 26g  # 24 agents Ã— 1GB + 2GB for orchestrator
    cpus: 8.0       # Use all available CPUs
    pids_limit: 32768  # Increased: Docker daemon + 24 agents + health checks
    ulimits:
      nproc:
        soft: 65535
        hard: 65535
      nofile:
        soft: 65535
        hard: 65535

volumes:
  dind-certs:

networks:
  traitorsim-dind:
    driver: bridge
